[variables]
    # Variável crucial para o Nixpacks ativar as extensões no runtime
    NIXPACKS_PHP_EXTENSIONS = 'intl, gd, zip, opcache, pdo_mysql'
    # Fallback para garantir
    PHP_EXTENSIONS = 'intl, gd, zip, opcache'

[phases.setup]
    nixPkgs = [
        'php84',
        'php84Packages.composer',
        'php84Packages.intl',
        'php84Packages.zip',
        'php84Packages.gd',
        'nodejs_20'
    ]

[phases.install]
    cmds = [
        'composer install --optimize-autoloader --no-interaction --ignore-platform-reqs',
        'npm install'
    ]

[phases.build]
    cmds = [
        'npm run build',
        # Removido artisan optimize para evitar travas de cache em deploy
        'php artisan config:clear',
        'php artisan view:clear'
    ]

[start]
    # Comando limpo e direto para o diretório public
    cmd = 'php artisan migrate --force && php -S 0.0.0.0:$PORT -t public'